---
title: "Latent Growth Models with Raw Scale Scores"
author: "KN"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  word_document:
    reference_docx: IPA R Template.docx
    toc: TRUE
    toc_depth: 3
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, results = "asis")
flextable::set_flextable_defaults(fonts_ignore = TRUE)
library(knitr)
library(rmarkdown)
library(flextable)
library(dplyr)


load("../Output/Scale_Score_LGM_Results.RData")


format_flex <- function(df, bold = TRUE, digits = 2){
  
  numericcols <- which(unlist(lapply(df, is.numeric)))
  
  ftab <- flextable(df)
  ftab <- colformat_double(ftab, j = numericcols, digits = digits)
  ftab <- flextable::font(ftab, fontname = "Times New Roman", part = "all")
  ftab <- flextable::padding(ftab, padding = 3, part = "all")
  
  if(bold == TRUE){
  ftab <- bold(ftab, i = ~ pvalue < .05, part =  "body")
  # ftab <- bold(ftab, i = ~ est.std > .20, part = "body")
  }
  
  ftab <- autofit(ftab)
  ftab <- fit_to_width(ftab, 8)
  
  return(ftab)
}

two_level_flex <- function(flex, mapping, vert.cols, border){

  flex <- flextable::set_header_df(flex, mapping = mapping)
  flex <- flextable::merge_h(flex, part = "header")
  flex <- flextable::merge_v(flex, j = vert.cols, part = "header")
  flex <- flextable::fix_border_issues(flex)
  flex <- flextable::border_inner_h(flex, border = border, part = "header")
  flex <- flextable::hline_top(flex, border = border, part = "all")
  # flex <- flextable::theme_vanilla(flex)
  flex <- flextable::align(flex, align = "center", part = "all")
  flex <- flextable::font(flex, fontname = "Times New Roman", part = "all")
  flex <- flextable::padding(flex, padding = 3, part = "all")
  flex <- flextable::autofit(flex)
}

border <- officer::fp_border(width = 2) # manual horizontal flextable border width

```

# Methods

Raw scale scores were calculated as the mean item score for Depression and Delinquency and as the sum of the dichotomous items for Sexual Harassment. A student must have answered 3 or more items in the scale to receive a scale score. Descriptive statistics and correlations between the scale scores at each wave are in Table 1.

The latent growth model was specified by loading the scale score at each wave onto an intercept and slope factor. The models were estimated with both Mplus and the lavaan package in R using a robust maximum likelihood estimator with cluster robust standard errors accounting for the nesting structure of students within schools. Missing data was handled using full information maximum likelihood.

Multigroup analyses by gender, race, and school belonging were then run on the latent growth models for each outcome to examine differences in the parameter estimates. Prior to the multigroup analysis, the latent growth model for each outcome was fit separately to each group. Then, for a given variable (e.g., gender) and outcome (e.g., sexual harassment), the latent growth model was fit with the parameter estimates free to vary between the groups. A second model was then fit constraining the parameter estimates to equality. The models were compared using a likelihood ratio test with the Satorra and Bentler (2001) scaled difference test statistic and change in fit indices (i.e., CFI, RMSEA, and SRMR). When the model with equality constraints fits as well as the freely estimated model, the groups have statistically similar intercepts and slopes.

Lastly, Wave 1 variables were added to the model as intercept and slope predictors. When the multigroup analysis indicated groups had different intercepts and slopes, the model with predictors was fit separately to each group.

# Results

## Latent Growth Model - Full Sample

```{r lgm}
cat("**Model Fit**")
cat("\n\n")
format_flex(lgm.ss.mplus.results$Fit, bold = FALSE) %>% knit_print()
cat("\n\n")
cat("**Unstandardized Parameter Estimates**")
cat("\n\n")
format_flex(lgm.ss.mplus.results$Estimates, bold = FALSE) %>% knit_print()
cat("*Note.* Cluster robust standard errors are in the parentheses (). \\**p* < .05")
cat("\n\n")
```
 
**Summary**

 - Each outcome is adequately estimated by the latent growth model
 - At baseline, students report perpetrating an average of .88 delinquent behaviors and .23 sexual harassment behaviors. The mean student response across the 8 depression items was 1.10 indicating they "not often" felt depressive symptoms.
 - All three outcomes increased significantly over time
 - There was also significant variation across students in both the baseline rates and changes over time

## LGM Stratified by Group

```{r lgm strat}

for(i in 1:length(lgm.ss.strat.results$Fit)){
  cat("###", names(lgm.ss.strat.results$Fit)[[i]])
  cat("\n\n")
  cat("**Model Fit**")
  cat("\n\n")
  format_flex(lgm.ss.strat.results$Fit[[i]], bold = FALSE) %>% knit_print() %>% cat()
  cat("\n\n")
  cat("**Unstandardized Parameter Estimates**")
  cat("\n\n")
  format_flex(lgm.ss.strat.results$Estimates[[i]], bold = FALSE) %>% knit_print() %>% cat()
  cat("\n\n")
}
```
 
**Summary**

 - Sexual Harassment
   - There was little to no variation in Sexual Harassment perpetration slopes for students with high school belonging nor for other racial students. To improve model convergence the slope variance (and therefore also the intercept and slope covariance) was constrained to 0.
   - With the exception of Hispanic students, SH perpetration increased significantly over time.
   - Students with moderate school belonging reported the highest average baseline rate and slope
 - Depression
   - Overall model fit was adequate for all groups expect other race students.
   - Students with moderate school belonging reported the highest average baseline rate while female students had the largest average slope.
 - Delinquency
   - Model fit is suspect for Hispanic, White, and students with moderate school belonging

## Multigroup Analysis

### Gender

```{r gen.descrips, fig.height=6, fig.width=8}
cat("**Score Distribution by Wave**")
cat("\n\n")
print(gen.ss.mplus.results$Distribution_Plot)
cat("\n\n")
```
 

```{r gen, fig.height=4, fig.width=11}
cat("**Model Fit**")
cat("\n\n")
format_flex(gen.ss.mplus.results$Model_Comparison, bold = FALSE) %>% knit_print()
cat("\n\n")
cat("**Freely Estimated Unstandardized Growth Parameters**")
cat("\n\n")
format_flex(gen.ss.mplus.results$Estimate_Table, bold = FALSE) %>% knit_print()
cat("*Note.* Cluster robust standard errors are in the parentheses (). \\**p* < .05")
cat("\n\n")
cat("**Growth Curve Across 4 Waves**")
cat("\n\n")
print(gen.ss.mplus.results$Estimate_Plot)
```
 

### Race

```{r race.descrips, fig.height=6, fig.width=8}
cat("**Score Distribution by Wave**")
cat("\n\n")
print(race.ss.mplus.results$Distribution_Plot)
cat("\n\n")
```
 

```{r race, fig.height=4, fig.width=11}
cat("**Model Fit**")
cat("\n\n")
format_flex(race.ss.mplus.results$Model_Comparison, bold = FALSE) %>% knit_print()
cat("\n\n")
cat("**Freely Estimated Unstandardized Growth Parameters**")
cat("\n\n")
format_flex(race.ss.results$Estimate_Table, bold = FALSE) %>% knit_print()
cat("*Note.* Cluster robust standard errors are in the parentheses (). \\**p* < .05")
cat("\n\n")
cat("**Growth Curve Across 4 Waves**")
cat("\n\n")
print(race.ss.mplus.results$Estimate_Plot)
```
 
 
### School Belonging

```{r bel.descrips, fig.height=6, fig.width=8}
cat("**Score Distribution by Wave**")
cat("\n\n")
print(bel.ss.mplus.results$Distribution_Plot)
cat("\n\n")
```
 

```{r bel, fig.height=4, fig.width=11}
cat("**Model Fit**")
cat("\n\n")
format_flex(bel.ss.mplus.results$Model_Comparison, bold = FALSE) %>% knit_print()
cat("\n\n")
cat("**Freely Estimated Unstandardized Growth Parameters**")
cat("\n\n")
format_flex(bel.ss.mplus.results$Estimate_Table, bold = FALSE) %>% knit_print()
cat("*Note.* Cluster robust standard errors are in the parentheses (). \\**p* < .05")
cat("\n\n")
cat("**Growth Curve Across 4 Waves**")
cat("\n\n")
print(bel.ss.mplus.results$Estimate_Plot)
```
 
 
## Wave 1 Predictors

### Gender

```{r gender.w1, results='asis'}

cat("*Main Effects*")
cat("\n\n")
cat("**Model Fit**")
cat("\n\n")
format_flex(gen.ss.w1p.fit, bold = FALSE) %>% knit_print()
cat("\n\n")
cat("**Standardized Estimates**")
cat("\n\n")
gen.map <- data.frame(col_keys = names(gen.ss.w1p.est),
                      top = c("predictor", rep(rep(c("Sexual Harassment", "Delinquency", "Depression"), each = 2), each = 2)),
                      middle = c("predictor",rep(rep(c("Female", "Male"), times = 3), each = 2)),
                      bottom = c("predictor", rep(c("I", "S"), times = 6)))

gen.ss.w1p.flex <- flextable(gen.ss.w1p.est) %>% two_level_flex(mapping = gen.map, vert.cols = "predictor", border = border) %>%
  autofit() %>% fit_to_width(10)
knit_print(gen.ss.w1p.flex)
```


```{r gender.w1.int, results='asis'}

cat("*With Interactions*")
cat("\n\n")
cat("**Model Fit**")
cat("\n\n")
format_flex(gen.ss.w1p.int.fit, bold = FALSE) %>% knit_print()
cat("\n\n")
cat("**Standardized Estimates**")
cat("\n\n")
gen.ss.w1p.int.flex <- flextable(gen.ss.w1p.int.est) %>% two_level_flex(mapping = gen.map, vert.cols = "predictor", border = border) %>%
  autofit() %>% fit_to_width(10)
knit_print(gen.ss.w1p.int.flex)
```


### Race

```{r race.w1, results='asis'}

cat("*Main Effects*")
cat("\n\n")
cat("**Model Fit**")
cat("\n\n")
format_flex(race.ss.w1p.fit, bold = FALSE) %>% knit_print()
cat("\n\n")
cat("**Standardized Estimates**")
cat("\n\n")
race.map <- data.frame(col_keys = names(race.ss.w1p.est),
                            top = c("predictor", rep(rep(c("Sexual Harassment", "Delinquency", "Depression"), each = 3),
                                                     each = 2)),
                            middle = c("predictor", rep(rep(c("Black", "White", "Hispanic"), times = 3),
                                                        each = 2)),
                           bottom = c("predictor", rep(c("I", "S"), times = (ncol(race.ss.w1p.est)-1)/2)))

race.ss.w1p.flex <- flextable(race.ss.w1p.est) %>% two_level_flex(mapping = race.map, vert.cols = "predictor", border = border) %>%
  autofit() %>% fit_to_width(10)
knit_print(race.ss.w1p.flex)
```


```{r race.w1.int, results='asis'}

cat("*With Interactions*")
cat("\n\n")
cat("**Model Fit**")
cat("\n\n")
format_flex(race.ss.w1p.int.fit, bold = FALSE) %>% knit_print()
cat("\n\n")
cat("**Standardized Estimates**")
cat("\n\n")
race.ss.w1p.int.flex <- flextable(race.ss.w1p.int.est) %>% two_level_flex(mapping = race.map, vert.cols = "predictor", border = border) %>%
  autofit() %>% fit_to_width(10)
knit_print(race.ss.w1p.int.flex)
```


### School Belonging

```{r bel.w1, results='asis'}

cat("**Model Fit**")
cat("\n\n")
format_flex(bel.ss.w1p.fit, bold = FALSE) %>% knit_print()
cat("\n\n")
cat("**Standardized Estimates**")
cat("\n\n")
bel.map <- data.frame(col_keys = names(bel.ss.w1p.est),
                      top = c("predictor", rep(rep(c("Sexual Harassment", "Delinquency", "Depression"), each = 2), each = 2)),
                      middle = c("predictor",rep(rep(c("High", "Moderate"), times = 3), each = 2)),
                      bottom = c("predictor", rep(c("I", "S"), times = (ncol(bel.ss.w1p.est)-1)/2)))

bel.ss.w1p.flex <- flextable(bel.ss.w1p.est) %>% two_level_flex(mapping = bel.map, vert.cols = "predictor", border = border) %>%
  autofit() %>% fit_to_width(10)
knit_print(bel.ss.w1p.flex)
```


# Additional Plots for Paper

*Interaction of Academic Grades and Early Hostile Home Environment on Female Adolescents’ Sexual Harassment Perpetration*

```{r fem.absa.intx.plot, fig.width=10, fig.height=10}
print(fem.absa.intx.plot)
```

*Interaction of Exposure to Abuse and School Variables on Hispanic Adolescents’ Sexual Harassment Perpetration*

```{r hisp.intx.plot, fig.width=12, fig.height=12}
hisp.intx.plot <- cowplot::plot_grid(hisp.abhsb.intx.plot, hisp.abag.intx.plot,
                                     align = "v", ncol = 1, labels = "AUTO")
print(hisp.intx.plot)
```

*Interaction of Academic Grades and Early Hostile Home Environment on Black Adolescents’ Sexual Harassment Perpetration*

```{r black.fcsa.intx.plot, fig.width=10, fig.height=10}
print(black.fcsa.intx.plot)
```


*Interaction of School Belonging and Early Hostile Home Environment on Black (A), White (B), and Male (C) Adolescents’ Sexual Harassment Perpetration*

```{r hsb.intx.plot, fig.width=10, fig.height=15}

hsb.intx.plot <- cowplot::plot_grid(black.fc.intx.plot, white.sa.intx.plot, male.ab.intx.plot,
                                     align = "v", ncol = 1, labels = "AUTO")
print(hsb.intx.plot)

```


```{r SHPlot.grid, fig.width=17, fig.height=7}
print(SHPlot.grid)
```



```{r r2, results='asis'}
format_flex(all.r2, bold = FALSE) %>% knit_print()
```



